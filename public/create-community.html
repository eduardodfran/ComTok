<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Community - ComTok</title>
    <!-- Add Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#0F52BA', // Filipino flag blue
              secondary: '#CE1126', // Filipino flag red
              accent: '#FCD116', // Filipino flag yellow
            },
          },
        },
      }
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div
        class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center"
      >
        <div class="logo">
          <a href="index.html">
            <h1 class="text-2xl md:text-3xl font-bold">
              Com<span class="text-primary">Tok</span>
            </h1>
          </a>
        </div>
        <nav class="mt-4 md:mt-0">
          <ul class="flex flex-wrap justify-center gap-6">
            <li>
              <a
                href="index.html"
                class="font-medium hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-0 after:bg-primary after:transition-all hover:after:w-full"
                >Home</a
              >
            </li>
            <li>
              <a
                href="explore.html"
                class="font-medium hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-0 after:bg-primary after:transition-all hover:after:w-full"
                >Explore Communities</a
              >
            </li>
            <li>
              <a
                href="trending.html"
                class="font-medium hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-0 after:bg-primary after:transition-all hover:after:w-full"
                >Trending Topics</a
              >
            </li>
            <li>
              <a
                href="about.html"
                class="font-medium hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-0 after:bg-primary after:transition-all hover:after:w-full"
                >About Us</a
              >
            </li>
          </ul>
        </nav>
        <div id="user-actions" class="user-actions mt-4 md:mt-0 flex gap-2">
          <!-- This will be dynamically populated based on auth state -->
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gray-200 rounded-full animate-pulse"></div>
            <div class="w-20 h-4 bg-gray-200 rounded animate-pulse"></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Create Community Form Section -->
    <section class="py-16 md:py-24">
      <div class="container mx-auto px-4 max-w-2xl">
        <div class="bg-white rounded-xl shadow-md p-8 mb-8">
          <h1 class="text-2xl font-bold text-center mb-8">
            Create a New Community
          </h1>

          <div
            id="error-message"
            class="hidden bg-red-100 text-secondary p-4 rounded-lg mb-6"
          ></div>
          <div
            id="success-message"
            class="hidden bg-green-100 text-green-700 p-4 rounded-lg mb-6"
          ></div>

          <form id="community-form" class="space-y-6">
            <div>
              <label
                for="name"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Community Name</label
              >
              <input
                type="text"
                id="community-name"
                name="name"
                required
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                placeholder="Community name"
              />
            </div>

            <div>
              <label
                for="description"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Description</label
              >
              <textarea
                id="description"
                name="description"
                required
                rows="4"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                placeholder="Describe your community..."
              ></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  for="region"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Region</label
                >
                <select
                  id="region"
                  name="region"
                  required
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                >
                  <option value="">Select Region</option>
                  <option value="ncr">National Capital Region</option>
                  <option value="region1">Ilocos Region</option>
                  <option value="region2">Cagayan Valley</option>
                  <option value="region3">Central Luzon</option>
                  <option value="region4a">CALABARZON</option>
                  <option value="region4b">MIMAROPA</option>
                  <option value="region5">Bicol Region</option>
                  <option value="region6">Western Visayas</option>
                  <option value="region7">Central Visayas</option>
                  <option value="region8">Eastern Visayas</option>
                </select>
              </div>

              <div>
                <label
                  for="province"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Province</label
                >
                <select
                  id="province"
                  name="province"
                  required
                  disabled
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                >
                  <option value="">Select Province</option>
                </select>
              </div>

              <div>
                <label
                  for="city"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >City/Municipality</label
                >
                <select
                  id="city"
                  name="city"
                  disabled
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                >
                  <option value="">Select City</option>
                </select>
              </div>

              <div>
                <label
                  for="barangay"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Barangay</label
                >
                <select
                  id="barangay"
                  name="barangay"
                  disabled
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                >
                  <option value="">Select Barangay</option>
                </select>
              </div>
            </div>

            <div>
              <label
                for="community-image"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Community Image (Optional)</label
              >
              <input
                type="file"
                id="community-image"
                name="image"
                accept="image/*"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
              />
            </div>

            <button
              type="submit"
              class="w-full py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition duration-300 font-medium text-lg"
            >
              Create Community
            </button>
          </form>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white pt-16 pb-6">
      <!-- ...existing code... -->
    </footer>

    <!-- Include the Firebase config -->
    <script src="js/firebase-config.js"></script>
    <!-- Include auth check script -->
    <script src="js/auth-check.js"></script>
    <script>
      // DOM Elements
      const communityForm = document.getElementById('community-form')
      const errorMessage = document.getElementById('error-message')
      const successMessage = document.getElementById('success-message')
      const userActionsDiv = document.getElementById('user-actions')

      // Form elements
      const regionSelect = document.getElementById('region')
      const provinceSelect = document.getElementById('province')
      const citySelect = document.getElementById('city')
      const barangaySelect = document.getElementById('barangay')

      // Update user actions with authenticated user info
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          try {
            const userDoc = await db.collection('users').doc(user.uid).get()
            const userData = userDoc.data()

            userActionsDiv.innerHTML = `
              <div class="flex items-center gap-2">
                <img src="${
                  userData.avatarUrl || 'https://via.placeholder.com/40'
                }" alt="${userData.username}" class="w-8 h-8 rounded-full">
                <div class="relative group">
                  <button class="font-medium">${userData.username}</button>
                  <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg hidden group-hover:block z-50">
                    <ul class="py-2">
                      <li><a href="profile.html" class="block px-4 py-2 hover:bg-gray-100">My Profile</a></li>
                      <li><a href="my-communities.html" class="block px-4 py-2 hover:bg-gray-100">My Communities</a></li>
                      <li><a href="settings.html" class="block px-4 py-2 hover:bg-gray-100">Settings</a></li>
                      <li><button id="logout-btn" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Log Out</button></li>
                    </ul>
                  </div>
                </div>
              </div>
            `

            document
              .getElementById('logout-btn')
              .addEventListener('click', () => {
                auth.signOut().then(() => {
                  window.location.href = 'index.html'
                })
              })
          } catch (error) {
            console.error('Error fetching user data:', error)
          }
        }
      })

      // Handle form submission
      communityForm.addEventListener('submit', async (e) => {
        e.preventDefault()

        // Clear previous messages
        errorMessage.classList.add('hidden')
        successMessage.classList.add('hidden')

        // Get form values
        const name = document.getElementById('community-name').value
        const description = document.getElementById('description').value
        const regionId = regionSelect.value
        const provinceId = provinceSelect.value
        const cityId = citySelect.value || null
        const barangayId = barangaySelect.value || null
        const imageFile = document.getElementById('community-image').files[0]

        // Show loading state
        const submitButton = communityForm.querySelector(
          'button[type="submit"]'
        )
        const originalButtonText = submitButton.textContent
        submitButton.textContent = 'Creating community...'
        submitButton.disabled = true

        try {
          // Get current user
          const user = auth.currentUser
          if (!user)
            throw new Error('You must be logged in to create a community')

          // Upload image if provided
          let imageUrl = null
          if (imageFile) {
            const storageRef = firebase.storage().ref()
            const fileRef = storageRef.child(
              `community-images/${Date.now()}-${imageFile.name}`
            )
            await fileRef.put(imageFile)
            imageUrl = await fileRef.getDownloadURL()
          }

          // Create community in database
          const communityData = {
            name,
            description,
            regionId,
            provinceId,
            cityId,
            barangayId,
            imageUrl,
            createdBy: user.uid,
            members: [user.uid],
            membersCount: 1,
            activity: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          }

          // Add community to Firestore
          const communityRef = await db
            .collection('communities')
            .add(communityData)

          // Add community to user's joined communities
          await db
            .collection('users')
            .doc(user.uid)
            .update({
              joinedCommunities: firebase.firestore.FieldValue.arrayUnion(
                communityRef.id
              ),
            })

          // Show success message
          successMessage.textContent =
            'Community created successfully! Redirecting...'
          successMessage.classList.remove('hidden')

          // Redirect to community page
          setTimeout(() => {
            window.location.href = `community.html?id=${communityRef.id}`
          }, 2000)
        } catch (error) {
          // Reset button
          submitButton.textContent = originalButtonText
          submitButton.disabled = false

          // Show error message
          errorMessage.textContent = error.message
          errorMessage.classList.remove('hidden')
          console.error('Error creating community:', error)
        }
      })

      // Event listeners for region, province, city selectors
      // Similar to your existing code in script.js
      // Will need to implement the same cascading selection logic
      // ...
    </script>
  </body>
</html>

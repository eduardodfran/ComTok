<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ComTok - Connect with Filipino Communities</title>
    <!-- Add Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#0F52BA', // Filipino flag blue
              secondary: '#CE1126', // Filipino flag red
              accent: '#FCD116', // Filipino flag yellow
            },
          },
        },
      }
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <!-- Add Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div
        class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center"
      >
        <div class="logo">
          <h1 class="text-2xl md:text-3xl font-bold">
            Com<span class="text-primary">Tok</span>
          </h1>
        </div>
        <nav class="mt-4 md:mt-0">
          <ul class="flex flex-wrap justify-center gap-6">
            <li>
              <a
                href="index.html"
                class="font-medium hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-0 after:bg-primary after:transition-all hover:after:w-full"
                >Home</a
              >
            </li>
            <li>
              <a
                href="explore.html"
                class="font-medium hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-0 after:bg-primary after:transition-all hover:after:w-full"
                >Explore Communities</a
              >
            </li>
            <li>
              <a
                href="trending.html"
                class="font-medium hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-0 after:bg-primary after:transition-all hover:after:w-full"
                >Trending Topics</a
              >
            </li>
            <li>
              <a
                href="about.html"
                class="font-medium hover:text-primary transition-colors relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-0 after:bg-primary after:transition-all hover:after:w-full"
                >About Us</a
              >
            </li>
          </ul>
        </nav>
        <div id="user-actions" class="user-actions mt-4 md:mt-0 flex gap-2">
          <!-- This will be dynamically populated based on auth state -->
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-gray-200 rounded-full animate-pulse"></div>
            <div class="w-20 h-4 bg-gray-200 rounded animate-pulse"></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Hero Section - Only show for non-authenticated users -->
    <div id="guest-welcome">
      <section class="bg-white py-16 md:py-24">
        <div
          class="container mx-auto px-4 flex flex-col md:flex-row items-center gap-8 md:gap-16"
        >
          <div class="hero-content w-full md:w-1/2">
            <h2
              class="text-3xl md:text-4xl lg:text-5xl font-bold text-primary leading-tight mb-4"
            >
              Connect with Your Filipino Community
            </h2>
            <p class="text-gray-600 text-lg mb-8">
              Discuss local issues, share news, and connect with fellow
              Filipinos from your barangay to the entire nation
            </p>
            <div class="flex flex-col sm:flex-row gap-4">
              <button
                class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition duration-300 font-medium text-lg"
              >
                Join ComTok Today
              </button>
              <button
                class="px-6 py-3 border border-primary text-primary rounded-lg hover:bg-gray-100 transition duration-300 font-medium text-lg"
              >
                Explore Communities
              </button>
            </div>
          </div>
          <div class="hero-image w-full md:w-1/2">
            <img
              src="https://source.unsplash.com/random/800x600/?philippines,community"
              alt="Filipino Community"
              class="rounded-xl shadow-lg w-full h-auto object-cover hover:scale-[1.02] transition duration-500"
            />
          </div>
        </div>
      </section>
    </div>

    <!-- Main Content -->
    <div
      class="container mx-auto px-4 py-6 md:py-10 flex flex-col lg:flex-row gap-6"
    >
      <!-- Sidebar -->
      <aside class="w-full lg:w-80 space-y-6">
        <!-- Create Post Button -->
        <div class="bg-white rounded-lg shadow p-4">
          <button
            id="create-post-btn"
            class="w-full py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition duration-300 font-medium"
          >
            Create Post
          </button>
        </div>

        <!-- Community Navigator -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold text-lg mb-3">Find Your Community</h3>
          <div class="space-y-3">
            <div>
              <label class="text-sm text-gray-500 mb-1 block">Region</label>
              <select
                id="region-select"
                class="w-full p-2 border border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition text-sm"
              >
                <option value="">Select Region</option>
                <option value="ncr">National Capital Region</option>
                <option value="region1">Ilocos Region</option>
                <option value="region2">Cagayan Valley</option>
                <option value="region3">Central Luzon</option>
                <option value="region4a">CALABARZON</option>
                <option value="region4b">MIMAROPA</option>
                <option value="region5">Bicol Region</option>
                <option value="region6">Western Visayas</option>
                <option value="region7">Central Visayas</option>
                <option value="region8">Eastern Visayas</option>
              </select>
            </div>
            <div class="hidden md:flex text-primary">
              <i class="fas fa-chevron-right"></i>
            </div>
            <div class="w-full md:w-auto">
              <h4 class="text-sm text-gray-500 mb-2">Province</h4>
              <select
                id="province-select"
                class="w-full md:w-64 p-3 border border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition"
                disabled
              >
                <option value="">Select Province</option>
              </select>
            </div>
            <div class="hidden md:flex text-primary">
              <i class="fas fa-chevron-right"></i>
            </div>
            <div class="w-full md:w-auto">
              <h4 class="text-sm text-gray-500 mb-2">City/Municipality</h4>
              <select
                id="city-select"
                class="w-full md:w-64 p-3 border border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition"
                disabled
              >
                <option value="">Select City</option>
              </select>
            </div>
            <div class="hidden md:flex text-primary">
              <i class="fas fa-chevron-right"></i>
            </div>
            <div class="w-full md:w-auto">
              <h4 class="text-sm text-gray-500 mb-2">Barangay</h4>
              <select
                id="barangay-select"
                class="w-full md:w-64 p-3 border border-gray-200 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition"
                disabled
              >
                <option value="">Select Barangay</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Popular Communities -->
        <div class="bg-white rounded-lg shadow p-4">
          <h3 class="font-semibold text-lg mb-3">Popular Communities</h3>
          <ul class="space-y-2">
            <li>
              <a
                href="community.html?id=metro-manila"
                class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded-md transition-colors"
              >
                <img
                  src="https://source.unsplash.com/random/32x32/?manila"
                  alt="Metro Manila"
                  class="w-8 h-8 rounded-full"
                />
                <div>
                  <div class="font-medium">r/MetroManila</div>
                  <div class="text-xs text-gray-500">12.8k members</div>
                </div>
              </a>
            </li>
            <li>
              <a
                href="community.html?id=cebu-city"
                class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded-md transition-colors"
              >
                <img
                  src="https://source.unsplash.com/random/32x32/?cebu"
                  alt="Cebu City"
                  class="w-8 h-8 rounded-full"
                />
                <div>
                  <div class="font-medium">r/CebuCity</div>
                  <div class="text-xs text-gray-500">8.5k members</div>
                </div>
              </a>
            </li>
            <li>
              <a
                href="community.html?id=davao-city"
                class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded-md transition-colors"
              >
                <img
                  src="https://source.unsplash.com/random/32x32/?davao"
                  alt="Davao City"
                  class="w-8 h-8 rounded-full"
                />
                <div>
                  <div class="font-medium">r/DavaoCity</div>
                  <div class="text-xs text-gray-500">6.2k members</div>
                </div>
              </a>
            </li>
            <li>
              <a
                href="explore.html"
                class="text-primary text-sm hover:underline"
                >View All Communities</a
              >
            </li>
          </ul>
        </div>
      </aside>

      <!-- Main Feed -->
      <main class="flex-1">
        <!-- Post Sorting -->
        <div
          class="bg-white rounded-lg shadow mb-4 p-3 flex items-center gap-4"
        >
          <div class="flex border border-gray-200 rounded-full">
            <button
              class="bg-primary text-white px-4 py-1 rounded-full text-sm font-medium"
            >
              Hot
            </button>
            <button
              class="text-gray-600 px-4 py-1 rounded-full text-sm font-medium hover:bg-gray-100"
            >
              New
            </button>
            <button
              class="text-gray-600 px-4 py-1 rounded-full text-sm font-medium hover:bg-gray-100"
            >
              Top
            </button>
          </div>
          <div class="ml-auto">
            <select class="border border-gray-200 rounded-lg text-sm p-2">
              <option>All Philippines</option>
              <option>My Communities</option>
            </select>
          </div>
        </div>

        <!-- Post Feed -->
        <div class="space-y-4" id="post-feed">
          <!-- Sample Post 1 -->
          <article class="bg-white rounded-lg shadow overflow-hidden">
            <!-- Vote Controls -->
            <div class="flex">
              <div class="bg-gray-50 p-2 flex flex-col items-center">
                <button class="text-gray-400 hover:text-primary p-1">
                  <i class="fas fa-arrow-up"></i>
                </button>
                <span class="font-medium text-sm">215</span>
                <button class="text-gray-400 hover:text-secondary p-1">
                  <i class="fas fa-arrow-down"></i>
                </button>
              </div>

              <!-- Post Content -->
              <div class="p-4 flex-1">
                <!-- Post Header -->
                <div class="mb-2">
                  <div class="flex items-center text-xs text-gray-500 mb-1">
                    <a
                      href="community.html?id=metro-manila"
                      class="font-medium text-black hover:underline mr-2"
                      >r/MetroManila</a
                    >
                    <span
                      >Posted by
                      <a href="user.html?id=user123" class="hover:underline"
                        >u/roadwarrior</a
                      >
                      • 2 hours ago</span
                    >
                  </div>
                  <h3 class="text-lg font-bold hover:underline cursor-pointer">
                    Upcoming EDSA Road Repairs
                  </h3>
                </div>

                <!-- Post Body -->
                <div class="mb-3">
                  <p>
                    Major road repairs scheduled for next week will affect
                    commute times. MMDA announced today that sections of EDSA
                    from Quezon Ave to North Ave will undergo repairs starting
                    Monday. Expect heavy traffic.
                  </p>
                </div>

                <!-- Post Footer -->
                <div class="flex text-gray-500 text-sm">
                  <a
                    href="post.html?id=post1"
                    class="flex items-center mr-4 hover:bg-gray-100 rounded-md px-2 py-1"
                  >
                    <i class="far fa-comment mr-1"></i> 48 comments
                  </a>
                  <button
                    class="flex items-center mr-4 hover:bg-gray-100 rounded-md px-2 py-1"
                  >
                    <i class="far fa-bookmark mr-1"></i> Save
                  </button>
                  <button
                    class="flex items-center hover:bg-gray-100 rounded-md px-2 py-1"
                  >
                    <i class="fas fa-share mr-1"></i> Share
                  </button>
                </div>
              </div>
            </div>
          </article>

          <!-- Sample Post 2 -->
          <article class="bg-white rounded-lg shadow overflow-hidden">
            <div class="flex">
              <div class="bg-gray-50 p-2 flex flex-col items-center">
                <button class="text-gray-400 hover:text-primary p-1">
                  <i class="fas fa-arrow-up"></i>
                </button>
                <span class="font-medium text-sm">342</span>
                <button class="text-gray-400 hover:text-secondary p-1">
                  <i class="fas fa-arrow-down"></i>
                </button>
              </div>

              <div class="p-4 flex-1">
                <div class="mb-2">
                  <div class="flex items-center text-xs text-gray-500 mb-1">
                    <a
                      href="community.html?id=makati"
                      class="font-medium text-black hover:underline mr-2"
                      >r/MakatiCity</a
                    >
                    <span
                      >Posted by
                      <a href="user.html?id=user456" class="hover:underline"
                        >u/greenthumbs</a
                      >
                      • 1 day ago</span
                    >
                  </div>
                  <h3 class="text-lg font-bold hover:underline cursor-pointer">
                    Urban Garden Initiative in Poblacion
                  </h3>
                </div>

                <div class="mb-3">
                  <p>
                    Residents start community gardens to promote sustainability
                    and food security. The project has transformed several
                    vacant lots into productive spaces.
                  </p>
                  <img
                    src="https://source.unsplash.com/random/600x400/?garden"
                    alt="Urban Garden"
                    class="mt-3 rounded-md w-full"
                  />
                </div>

                <div class="flex text-gray-500 text-sm">
                  <a
                    href="post.html?id=post2"
                    class="flex items-center mr-4 hover:bg-gray-100 rounded-md px-2 py-1"
                  >
                    <i class="far fa-comment mr-1"></i> 87 comments
                  </a>
                  <button
                    class="flex items-center mr-4 hover:bg-gray-100 rounded-md px-2 py-1"
                  >
                    <i class="far fa-bookmark mr-1"></i> Save
                  </button>
                  <button
                    class="flex items-center hover:bg-gray-100 rounded-md px-2 py-1"
                  >
                    <i class="fas fa-share mr-1"></i> Share
                  </button>
                </div>
              </div>
            </div>
          </article>

          <!-- More posts would be dynamically loaded here -->
        </div>

        <!-- Load More -->
        <div class="text-center mt-6">
          <button
            class="px-6 py-2 border border-primary text-primary rounded-lg hover:bg-gray-100 transition duration-300 font-medium"
          >
            Load More
          </button>
        </div>
      </main>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white pt-16 pb-6">
      <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
          <!-- Company Info -->
          <div>
            <h4
              class="text-xl font-bold mb-6 inline-block relative after:absolute after:w-10 after:h-0.5 after:bg-primary after:bottom-0 after:left-0 after:-mb-2"
            >
              Com<span class="text-accent">Tok</span>
            </h4>
            <p class="text-gray-400 mb-4">
              Connecting Filipino communities nationwide.
            </p>
            <div class="flex gap-4 mt-6">
              <a
                href="#"
                class="bg-white/10 w-10 h-10 flex items-center justify-center rounded-full hover:bg-primary transition duration-300 hover:-translate-y-1"
              >
                <i class="fab fa-facebook-f"></i>
              </a>
              <a
                href="#"
                class="bg-white/10 w-10 h-10 flex items-center justify-center rounded-full hover:bg-primary transition duration-300 hover:-translate-y-1"
              >
                <i class="fab fa-twitter"></i>
              </a>
              <a
                href="#"
                class="bg-white/10 w-10 h-10 flex items-center justify-center rounded-full hover:bg-primary transition duration-300 hover:-translate-y-1"
              >
                <i class="fab fa-instagram"></i>
              </a>
              <a
                href="#"
                class="bg-white/10 w-10 h-10 flex items-center justify-center rounded-full hover:bg-primary transition duration-300 hover:-translate-y-1"
              >
                <i class="fab fa-youtube"></i>
              </a>
            </div>
          </div>

          <!-- Navigation -->
          <div>
            <h4
              class="text-xl font-bold mb-6 inline-block relative after:absolute after:w-10 after:h-0.5 after:bg-primary after:bottom-0 after:left-0 after:-mb-2"
            >
              Navigation
            </h4>
            <ul class="space-y-3">
              <li>
                <a
                  href="index.html"
                  class="text-gray-400 hover:text-white transition"
                  >Home</a
                >
              </li>
              <li>
                <a
                  href="explore.html"
                  class="text-gray-400 hover:text-white transition"
                  >Explore</a
                >
              </li>
              <li>
                <a
                  href="about.html"
                  class="text-gray-400 hover:text-white transition"
                  >About Us</a
                >
              </li>
              <li>
                <a
                  href="contact.html"
                  class="text-gray-400 hover:text-white transition"
                  >Contact</a
                >
              </li>
              <li>
                <a
                  href="privacy.html"
                  class="text-gray-400 hover:text-white transition"
                  >Privacy Policy</a
                >
              </li>
            </ul>
          </div>

          <!-- Popular Regions -->
          <div>
            <h4
              class="text-xl font-bold mb-6 inline-block relative after:absolute after:w-10 after:h-0.5 after:bg-primary after:bottom-0 after:left-0 after:-mb-2"
            >
              Popular Regions
            </h4>
            <ul class="space-y-3">
              <li>
                <a
                  href="region.html?id=ncr"
                  class="text-gray-400 hover:text-white transition"
                  >National Capital Region</a
                >
              </li>
              <li>
                <a
                  href="region.html?id=region7"
                  class="text-gray-400 hover:text-white transition"
                  >Central Visayas</a
                >
              </li>
              <li>
                <a
                  href="region.html?id=region11"
                  class="text-gray-400 hover:text-white transition"
                  >Davao Region</a
                >
              </li>
              <li>
                <a
                  href="region.html?id=region3"
                  class="text-gray-400 hover:text-white transition"
                  >Central Luzon</a
                >
              </li>
              <li>
                <a
                  href="region.html?id=region4a"
                  class="text-gray-400 hover:text-white transition"
                  >CALABARZON</a
                >
              </li>
            </ul>
          </div>

          <!-- Contact -->
          <div>
            <h4
              class="text-xl font-bold mb-6 inline-block relative after:absolute after:w-10 after:h-0.5 after:bg-primary after:bottom-0 after:left-0 after:-mb-2"
            >
              Contact Us
            </h4>
            <p class="text-gray-400 mb-3">
              <i class="fas fa-envelope mr-2"></i> support@comtok.ph
            </p>
            <p class="text-gray-400 mb-3">
              <i class="fas fa-phone mr-2"></i> +63 2 8123 4567
            </p>
            <p class="text-gray-400 mb-3">
              <i class="fas fa-map-marker-alt mr-2"></i> Bonifacio Global City,
              Taguig, Philippines
            </p>
          </div>
        </div>
        <div
          class="border-t border-gray-800 pt-6 text-center text-gray-500 text-sm"
        >
          <p>&copy; 2023 ComTok. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- Include the Firebase config file -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyA9L1zp7FnEh7HZvcuRDM3PJqWnyOR1oCg',
        authDomain: 'comtok-c781f.firebaseapp.com',
        projectId: 'comtok-c781f',
        storageBucket: 'comtok-c781f.appspot.com',
        messagingSenderId: '331612044234',
        appId: '1:331612044234:web:b72933adb98bc68e6c6d33',
        measurementId: 'G-H9VQEV5F94',
      }

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig)
      const auth = firebase.auth()
      const db = firebase.firestore()
    </script>

    <script>
      // Add event listeners to all the navigation buttons
      document.addEventListener('DOMContentLoaded', function () {
        // Login button in the header
        const loginBtns = document.querySelectorAll(
          '.user-actions button:first-of-type, a.text-accent[href="login.html"]'
        )
        loginBtns.forEach((btn) => {
          btn.addEventListener('click', function () {
            window.location.href = 'login.html'
          })
        })

        // Sign up button in the header and hero section
        const signupBtns = document.querySelectorAll(
          '.user-actions button:last-of-type, .hero-content button:first-of-type, .bg-primary\\/90 button'
        )
        signupBtns.forEach((btn) => {
          btn.addEventListener('click', function () {
            window.location.href = 'signup.html'
          })
        })

        // Explore Communities buttons
        const exploreBtns = document.querySelectorAll(
          '.hero-content button:last-of-type, .text-center button.border.border-primary'
        )
        exploreBtns.forEach((btn) => {
          btn.addEventListener('click', function () {
            window.location.href = 'explore.html'
          })
        })

        // Create Community button
        const createCommunityBtn = document.querySelector(
          '.text-center button.bg-primary'
        )
        if (createCommunityBtn) {
          createCommunityBtn.addEventListener('click', function () {
            const user = auth.currentUser
            if (user) {
              window.location.href = 'create-community.html'
            } else {
              alert('You need to log in to create a community')
              window.location.href = 'login.html?redirect=create-community.html'
            }
          })
        }

        // Join buttons in community cards
        const joinButtons = document.querySelectorAll(
          '.p-6 button:not(.border)'
        )
        joinButtons.forEach((button) => {
          button.addEventListener('click', function () {
            const user = auth.currentUser
            if (user) {
              const communityName = this.closest('.p-6')
                .querySelector('h4')
                .textContent.trim()
              alert(`You've joined the ${communityName} community!`)
              // Change button text and style
              this.textContent = 'Joined'
              this.disabled = true
              this.classList.add('bg-gray-400')
              this.classList.remove('bg-primary', 'hover:bg-opacity-90')
            } else {
              alert('You need to log in to join communities')
              window.location.href = 'login.html?redirect=index.html'
            }
          })
        })

        // View More Topics button
        const viewMoreTopicsBtn = document.querySelector(
          'section.bg-white .text-center button'
        )
        if (viewMoreTopicsBtn) {
          viewMoreTopicsBtn.addEventListener('click', function () {
            window.location.href = 'trending.html'
          })
        }

        // Check auth state to update the UI
        auth.onAuthStateChanged((user) => {
          const userActionsDiv = document.getElementById('user-actions')
          if (user) {
            // User is logged in
            db.collection('users')
              .doc(user.uid)
              .get()
              .then((doc) => {
                // If the user document doesn't exist but the auth user does
                // (e.g. if they just signed up with Google but the Firestore call failed)
                if (!doc.exists) {
                  // Try to create the user profile
                  const emailUsername = user.email?.split('@')[0] || 'user'
                  const uniqueUsername = `${emailUsername}_${Math.random()
                    .toString(36)
                    .substring(2, 7)}`

                  // Create the user profile
                  return db
                    .collection('users')
                    .doc(user.uid)
                    .set({
                      uid: user.uid,
                      username: uniqueUsername,
                      email: user.email,
                      avatarUrl: user.photoURL || null,
                      bio: '',
                      joinedCommunities: [],
                      postCount: 0,
                      commentCount: 0,
                      createdAt:
                        firebase.firestore.FieldValue.serverTimestamp(),
                      updatedAt:
                        firebase.firestore.FieldValue.serverTimestamp(),
                    })
                    .then(() => {
                      // Reload the document after creating it
                      return db.collection('users').doc(user.uid).get()
                    })
                }
                return doc
              })
              .then((doc) => {
                if (doc.exists) {
                  const userData = doc.data()
                  userActionsDiv.innerHTML = `
                  <div class="flex items-center gap-2">
                    <img src="${
                      userData.avatarUrl || 'https://via.placeholder.com/40'
                    }" alt="${userData.username}" class="w-8 h-8 rounded-full">
                    <div class="relative group">
                      <button class="font-medium">${userData.username}</button>
                      <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg hidden group-hover:block z-50">
                        <ul class="py-2">
                          <li><a href="profile.html" class="block px-4 py-2 hover:bg-gray-100">My Profile</a></li>
                          <li><a href="my-communities.html" class="block px-4 py-2 hover:bg-gray-100">My Communities</a></li>
                          <li><a href="settings.html" class="block px-4 py-2 hover:bg-gray-100">Settings</a></li>
                          <li><button id="logout-btn" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Log Out</button></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                `

                  // Add logout handler
                  document
                    .getElementById('logout-btn')
                    .addEventListener('click', () => {
                      auth.signOut().then(() => {
                        window.location.reload()
                      })
                    })
                }
              })
              .catch((error) => {
                console.error('Error getting or creating user document:', error)
                // Fallback to basic user info if there's an error
                userActionsDiv.innerHTML = `
                  <div class="flex items-center gap-2">
                    <img src="${
                      user.photoURL || 'https://via.placeholder.com/40'
                    }" alt="${
                  user.displayName || 'User'
                }" class="w-8 h-8 rounded-full">
                    <div class="relative group">
                      <button class="font-medium">${
                        user.displayName || user.email || 'User'
                      }</button>
                      <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg hidden group-hover:block z-50">
                        <ul class="py-2">
                          <li><button id="logout-btn" class="block w-full text-left px-4 py-2 hover:bg-gray-100">Log Out</button></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                `

                // Add logout handler
                document
                  .getElementById('logout-btn')
                  .addEventListener('click', () => {
                    auth.signOut().then(() => {
                      window.location.reload()
                    })
                  })
              })
          } else {
            // User is not logged in
            userActionsDiv.innerHTML = `
              <button class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-gray-100 transition duration-300 font-medium">
                Log In
              </button>
              <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition duration-300 font-medium">
                Sign Up
              </button>
            `

            // Re-attach event listeners to the newly created buttons
            const loginBtn = userActionsDiv.querySelector(
              'button:first-of-type'
            )
            const signupBtn = userActionsDiv.querySelector(
              'button:last-of-type'
            )

            loginBtn.addEventListener('click', function () {
              window.location.href = 'login.html'
            })

            signupBtn.addEventListener('click', function () {
              window.location.href = 'signup.html'
            })
          }
        })
      })
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const createPostBtn = document.getElementById('create-post-btn')
        const guestWelcome = document.getElementById('guest-welcome')

        // Check auth state to update the UI
        auth.onAuthStateChanged((user) => {
          // Hide welcome section for logged in users
          if (user && guestWelcome) {
            guestWelcome.classList.add('hidden')
          }

          // ...existing user actions code...

          // Handle create post button
          if (createPostBtn) {
            createPostBtn.addEventListener('click', function () {
              if (user) {
                window.location.href = 'create-post.html'
              } else {
                alert('You need to log in to create a post')
                window.location.href = 'login.html?redirect=create-post.html'
              }
            })
          }

          // Load posts from Firestore
          loadPosts('hot')
        })

        // Sorting buttons
        const sortButtons = document.querySelectorAll(
          '.flex.border.border-gray-200.rounded-full button'
        )
        sortButtons.forEach((button) => {
          button.addEventListener('click', function () {
            // Remove active class from all buttons
            sortButtons.forEach((btn) => {
              btn.classList.remove('bg-primary', 'text-white')
              btn.classList.add('text-gray-600', 'hover:bg-gray-100')
            })

            // Add active class to clicked button
            this.classList.remove('text-gray-600', 'hover:bg-gray-100')
            this.classList.add('bg-primary', 'text-white')

            // Load posts with the selected sort
            loadPosts(this.textContent.toLowerCase())
          })
        })

        // Function to load posts from Firestore
        async function loadPosts(sortBy) {
          try {
            const postFeed = document.getElementById('post-feed')
            postFeed.innerHTML =
              '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-primary"></i></div>'

            let postsQuery

            // Build query based on sort type
            switch (sortBy) {
              case 'new':
                postsQuery = db
                  .collection('posts')
                  .orderBy('createdAt', 'desc')
                  .limit(10)
                break
              case 'top':
                postsQuery = db
                  .collection('posts')
                  .orderBy('upvotes', 'desc')
                  .limit(10)
                break
              case 'hot':
              default:
                postsQuery = db
                  .collection('posts')
                  .orderBy('activity', 'desc')
                  .limit(10)
                break
            }

            // Execute query
            const postsSnapshot = await postsQuery.get()

            if (postsSnapshot.empty) {
              postFeed.innerHTML =
                '<div class="text-center py-8 text-gray-500">No posts found</div>'
              return
            }

            // Process results
            const postsHTML = []

            for (const doc of postsSnapshot.docs) {
              const post = doc.data()
              post.id = doc.id

              // Get community data
              const communityDoc = await db
                .collection('communities')
                .doc(post.communityId)
                .get()
              const community = communityDoc.data()

              // Get user data
              const userDoc = await db
                .collection('users')
                .doc(post.userId)
                .get()
              const user = userDoc.data()

              // Calculate time ago
              const timeAgo = formatTimeAgo(post.createdAt.toDate())

              // Build post HTML
              // For brevity, I'm not including the full HTML template here
              // but it would follow the structure of the sample posts
              postsHTML.push(`
                <article class="bg-white rounded-lg shadow overflow-hidden">
                  <div class="flex">
                    <div class="bg-gray-50 p-2 flex flex-col items-center">
                      <button class="text-gray-400 hover:text-primary p-1 upvote-btn" data-id="${
                        post.id
                      }"><i class="fas fa-arrow-up"></i></button>
                      <span class="font-medium text-sm">${
                        post.upvotes - post.downvotes
                      }</span>
                      <button class="text-gray-400 hover:text-secondary p-1 downvote-btn" data-id="${
                        post.id
                      }"><i class="fas fa-arrow-down"></i></button>
                    </div>
                    
                    <div class="p-4 flex-1">
                      <div class="mb-2">
                        <div class="flex items-center text-xs text-gray-500 mb-1">
                          <a href="community.html?id=${
                            post.communityId
                          }" class="font-medium text-black hover:underline mr-2">r/${
                community.name
              }</a>
                          <span>Posted by <a href="user.html?id=${
                            post.userId
                          }" class="hover:underline">u/${
                user.username
              }</a> • ${timeAgo}</span>
                        </div>
                        <h3 class="text-lg font-bold hover:underline cursor-pointer post-title" data-id="${
                          post.id
                        }">${post.title}</h3>
                      </div>
                      
                      <div class="mb-3">
                        <p>${post.content.substring(0, 300)}${
                post.content.length > 300 ? '...' : ''
              }</p>
                        ${
                          post.imageUrl
                            ? `<img src="${post.imageUrl}" alt="Post image" class="mt-3 rounded-md w-full" />`
                            : ''
                        }
                      </div>
                      
                      <div class="flex text-gray-500 text-sm">
                        <a href="post.html?id=${
                          post.id
                        }" class="flex items-center mr-4 hover:bg-gray-100 rounded-md px-2 py-1">
                          <i class="far fa-comment mr-1"></i> ${
                            post.comments
                          } comments
                        </a>
                        <button class="flex items-center mr-4 hover:bg-gray-100 rounded-md px-2 py-1 save-btn" data-id="${
                          post.id
                        }">
                          <i class="far fa-bookmark mr-1"></i> Save
                        </button>
                        <button class="flex items-center hover:bg-gray-100 rounded-md px-2 py-1 share-btn" data-id="${
                          post.id
                        }">
                          <i class="fas fa-share mr-1"></i> Share
                        </button>
                      </div>
                    </div>
                  </div>
                </article>
              `)
            }

            postFeed.innerHTML = postsHTML.join('')

            // Add event listeners to the post elements
            addPostEventListeners()
          } catch (error) {
            console.error('Error loading posts:', error)
            const postFeed = document.getElementById('post-feed')
            postFeed.innerHTML =
              '<div class="text-center py-8 text-red-500">Error loading posts</div>'
          }
        }

        // Helper function to add event listeners to post elements
        function addPostEventListeners() {
          // Post title click
          document.querySelectorAll('.post-title').forEach((title) => {
            title.addEventListener('click', function () {
              window.location.href = `post.html?id=${this.dataset.id}`
            })
          })

          // Upvote buttons
          document.querySelectorAll('.upvote-btn').forEach((button) => {
            button.addEventListener('click', function () {
              handleVote(this.dataset.id, 'upvote')
            })
          })

          // Downvote buttons
          document.querySelectorAll('.downvote-btn').forEach((button) => {
            button.addEventListener('click', function () {
              handleVote(this.dataset.id, 'downvote')
            })
          })

          // Save buttons
          document.querySelectorAll('.save-btn').forEach((button) => {
            button.addEventListener('click', function () {
              savePost(this.dataset.id)
            })
          })

          // Share buttons
          document.querySelectorAll('.share-btn').forEach((button) => {
            button.addEventListener('click', function () {
              sharePost(this.dataset.id)
            })
          })
        }

        // Format time ago helper function
        function formatTimeAgo(date) {
          const seconds = Math.floor((new Date() - date) / 1000)

          let interval = Math.floor(seconds / 31536000)
          if (interval >= 1) {
            return interval === 1 ? '1 year ago' : `${interval} years ago`
          }

          interval = Math.floor(seconds / 2592000)
          if (interval >= 1) {
            return interval === 1 ? '1 month ago' : `${interval} months ago`
          }

          interval = Math.floor(seconds / 86400)
          if (interval >= 1) {
            return interval === 1 ? '1 day ago' : `${interval} days ago`
          }

          interval = Math.floor(seconds / 3600)
          if (interval >= 1) {
            return interval === 1 ? '1 hour ago' : `${interval} hours ago`
          }

          interval = Math.floor(seconds / 60)
          if (interval >= 1) {
            return interval === 1 ? '1 minute ago' : `${interval} minutes ago`
          }

          return 'just now'
        }

        // Handle post votes
        async function handleVote(postId, voteType) {
          try {
            const user = auth.currentUser
            if (!user) {
              alert('You need to log in to vote')
              window.location.href = 'login.html?redirect=index.html'
              return
            }

            const postRef = db.collection('posts').doc(postId)
            const postDoc = await postRef.get()

            if (!postDoc.exists) {
              console.error('Post does not exist')
              return
            }

            const post = postDoc.data()

            // Check if user already voted
            const isUpvoted =
              post.upvotedBy && post.upvotedBy.includes(user.uid)
            const isDownvoted =
              post.downvotedBy && post.downvotedBy.includes(user.uid)

            let upvotedBy = post.upvotedBy || []
            let downvotedBy = post.downvotedBy || []

            if (voteType === 'upvote') {
              if (isUpvoted) {
                // Remove upvote
                upvotedBy = upvotedBy.filter((id) => id !== user.uid)
              } else {
                // Add upvote and remove downvote if exists
                upvotedBy.push(user.uid)
                downvotedBy = downvotedBy.filter((id) => id !== user.uid)
              }
            } else {
              if (isDownvoted) {
                // Remove downvote
                downvotedBy = downvotedBy.filter((id) => id !== user.uid)
              } else {
                // Add downvote and remove upvote if exists
                downvotedBy.push(user.uid)
                upvotedBy = upvotedBy.filter((id) => id !== user.uid)
              }
            }

            // Update post
            await postRef.update({
              upvotedBy,
              downvotedBy,
              upvotes: upvotedBy.length,
              downvotes: downvotedBy.length,
            })

            // Reload posts to reflect changes
            const sortActive = document.querySelector(
              '.flex.border.border-gray-200.rounded-full button.bg-primary'
            )
            loadPosts(sortActive.textContent.toLowerCase())
          } catch (error) {
            console.error('Error handling vote:', error)
            alert('Error processing your vote')
          }
        }

        // Save post function
        async function savePost(postId) {
          try {
            const user = auth.currentUser
            if (!user) {
              alert('You need to log in to save posts')
              window.location.href = 'login.html?redirect=index.html'
              return
            }

            const userRef = db.collection('users').doc(user.uid)
            const userDoc = await userRef.get()

            if (!userDoc.exists) {
              console.error('User does not exist')
              return
            }

            const userData = userDoc.data()
            const savedPosts = userData.savedPosts || []

            if (savedPosts.includes(postId)) {
              // Remove from saved posts
              await userRef.update({
                savedPosts: firebase.firestore.FieldValue.arrayRemove(postId),
              })
              alert('Post removed from saved posts')
            } else {
              // Add to saved posts
              await userRef.update({
                savedPosts: firebase.firestore.FieldValue.arrayUnion(postId),
              })
              alert('Post saved successfully')
            }
          } catch (error) {
            console.error('Error saving post:', error)
            alert('Error saving post')
          }
        }

        // Share post function
        function sharePost(postId) {
          const url = `${window.location.origin}/post.html?id=${postId}`

          if (navigator.share) {
            navigator
              .share({
                title: 'Check out this post on ComTok',
                url: url,
              })
              .catch((error) => console.error('Error sharing:', error))
          } else {
            // Fallback for browsers that don't support Web Share API
            navigator.clipboard
              .writeText(url)
              .then(() => alert('Link copied to clipboard'))
              .catch((error) => console.error('Error copying link:', error))
          }
        }
      })
    </script>
  </body>
</html>
